<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #3ECF8E; }
        .status {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 18px;
        }
        .success { background: #0d3320; border: 1px solid #3ECF8E; }
        .error { background: #3d1f1f; border: 1px solid #EF4444; }
        .pending { background: #2d2d3d; border: 1px solid #666; }
        pre {
            background: #0d0d1a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
        }
        .test-item {
            padding: 15px;
            background: #2d2d3d;
            border-radius: 8px;
            margin: 10px 0;
        }
        .test-item.pass { border-left: 4px solid #3ECF8E; }
        .test-item.fail { border-left: 4px solid #EF4444; }
    </style>
</head>
<body>
    <h1>üîå Supabase Connection Test</h1>
    <div id="status" class="status pending">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="results"></div>

    <script type="module">
        import { initSupabase, getSupabase, getCurrentProfile } from './api/supabase-client.js';

        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('results');

        function addResult(name, success, details = '') {
            resultsEl.innerHTML += `
                <div class="test-item ${success ? 'pass' : 'fail'}">
                    <strong>${success ? '‚úÖ' : '‚ùå'} ${name}</strong>
                    ${details ? `<pre>${JSON.stringify(details, null, 2)}</pre>` : ''}
                </div>
            `;
        }

        async function runTests() {
            try {
                // Test 1: Initialize Supabase
                statusEl.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase SDK...';
                const client = await initSupabase();
                
                if (client) {
                    addResult('Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω', true);
                } else {
                    addResult('Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', false);
                    throw new Error('SDK failed to load');
                }

                // Test 2: Test connection by fetching roles
                statusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î...';
                const { data: roles, error: rolesError } = await client
                    .from('roles')
                    .select('*')
                    .limit(5);

                if (rolesError) {
                    addResult('–ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã roles', false, rolesError);
                } else {
                    addResult('–ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã roles', true, roles);
                }

                // Test 3: Check profiles table
                statusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã profiles...';
                const { data: profiles, error: profilesError } = await client
                    .from('profiles')
                    .select('id, telegram_id, first_name')
                    .limit(3);

                if (profilesError) {
                    addResult('–ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã profiles', false, profilesError);
                } else {
                    addResult('–ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã profiles', true, profiles || []);
                }

                // Test 4: Check companies table
                const { data: companies, error: companiesError } = await client
                    .from('companies')
                    .select('id, name')
                    .limit(3);

                if (companiesError) {
                    addResult('–ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã companies', false, companiesError);
                } else {
                    addResult('–ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã companies', true, companies || []);
                }

                // Test 5: Check Storage buckets
                statusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ Storage...';
                const { data: buckets, error: bucketsError } = await client
                    .storage
                    .listBuckets();

                if (bucketsError) {
                    addResult('–î–æ—Å—Ç—É–ø –∫ Storage', false, bucketsError);
                } else {
                    addResult('–î–æ—Å—Ç—É–ø –∫ Storage', true, buckets?.map(b => b.name) || []);
                }

                // All done
                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ!';

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message;
                console.error(error);
            }
        }

        runTests();
    </script>
</body>
</html>
